<!DOCTYPE html>
<html>
<head>
  <title>Dashboard Finanzas Mensual</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1, h2 { color: #2C3E50; }
    .selector, .meta-box, .kpi-box, .alerta-box, .cards, .charts, .leyenda, .refrescar-box { margin: 20px 0; }
    .card { display: inline-block; background: #f7f7f7; padding: 15px; border: 1px solid #ccc; border-radius: 8px; margin: 10px; min-width: 120px; }
    .chart-row { display: flex; flex-wrap: wrap; gap: 20px; }
    .chart-box { flex: 1 1 45%; }
    canvas { max-width: 100%; height: auto; }
    input[type="number"], select { padding: 5px; margin-left: 10px; }
    .leyenda { font-size: 14px; background: #eef; padding: 10px; border-radius: 6px; }
    button { padding: 6px 12px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Dashboard Finanzas Mensual</h1>

  <div class="leyenda">
    <p>
      üìÖ Selecciona el mes (hoja) para analizar. Todos los datos vienen desde un Google Sheets p√∫blico.<br>
      ‚ö†Ô∏è La meta mensual te permite configurar alertas y comparaciones visuales.
    </p>
  </div>

  <div class="selector">
    <label for="mes">Seleccionar mes:</label>
    <select id="mes" onchange="cambiarHoja()">
      <option value="Enero">Enero</option>
      <option value="Febrero">Febrero</option>
      <option value="Marzo">Marzo</option>
      <option value="Abril">Abril</option>
      <option value="Mayo">Mayo</option>
      <option value="Junio">Junio</option>
      <option value="Julio">Julio</option>
      <option value="Agosto">Agosto</option>
      <option value="Septiembre">Septiembre</option>
      <option value="Octubre">Octubre</option>
      <option value="Noviembre">Noviembre</option>
      <option value="Diciembre">Diciembre</option>
      <option value="Todos">Todos</option>
    </select>
  </div>

  <div class="meta-box">
    <label for="metaGasto">Meta mensual de gasto: $</label>
    <input type="number" id="metaGasto" value="15000" onchange="renderDashboard(datosFiltrados)">
  </div>

  <div class="refrescar-box">
    <button onclick="cargarDatos()">üîÑ Refrescar datos</button>
  </div>

  <div class="alerta-box" id="alerta"></div>

  <div class="kpi-box" id="kpis"></div>
  <div class="cards" id="cardsTarjetas"></div>

  <div class="charts">
    <div class="chart-row">
      <div class="chart-box"><canvas id="graficoCategoria"></canvas></div>
      <div class="chart-box"><canvas id="graficoTarjetas"></canvas></div>
    </div>
    <div class="chart-row">
      <div class="chart-box"><canvas id="graficoDiario"></canvas></div>
      <div class="chart-box"><canvas id="graficoAcumulado"></canvas></div>
    </div>
    <div class="chart-row">
      <div class="chart-box"><canvas id="graficoPromedio"></canvas></div>
    </div>
  </div>

  <script>
    const SHEET_ID = 'REEMPLAZAR_POR_TU_ID';  // Cambia por tu ID real de Google Sheets
    let datosFiltrados = [];
    let hojaActual = 'Mayo';

    document.getElementById('mes').value = hojaActual;

    function cambiarHoja() {
      hojaActual = document.getElementById('mes').value;
      cargarDatos();
    }

    async function cargarDatos() {
      const sheetName = hojaActual;
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${sheetName}&tqx=out:json`;

      try {
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;

        datosFiltrados = rows.map(row => ({
          fecha: row.c[0]?.f || row.c[0]?.v || '',
          monto: parseFloat(row.c[1]?.v || 0),
          tipo: row.c[2]?.v || '',
          tarjeta: row.c[3]?.v || '',
          concepto: row.c[4]?.v || '',
          tienda: row.c[5]?.v || '',
          categoria: row.c[6]?.v || '',
          msi: parseInt(row.c[7]?.v || 0),
          total_msi: parseInt(row.c[8]?.v || 0),
          fechaInicioCorte: row.c[9]?.f || '',
          fechaCorte: row.c[10]?.f || '',
          fechaPago: row.c[11]?.f || '',
          notas: row.c[12]?.v || ''
        }));

        renderDashboard(datosFiltrados);
      } catch (error) {
        alert("Error cargando los datos. Verifica que la hoja exista y sea p√∫blica.");
        console.error(error);
      }
    }

    function renderDashboard(data) {
      document.getElementById('kpis').innerHTML = `<p><em>Cargando KPIs y gr√°ficas...</em></p>`;
      document.getElementById('cardsTarjetas').innerHTML = '';
      document.getElementById('alerta').innerHTML = '';

      // Aqu√≠ se colocar√°n los c√°lculos de KPIs, alertas y gr√°ficos en la siguiente etapa
    }

    window.onload = () => {
      document.getElementById('mes').value = hojaActual;
      cargarDatos();
    };
  </script>
</body>
</html>
